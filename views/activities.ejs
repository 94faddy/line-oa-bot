<%- include('partials/header', {
    title: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ä‡∏£‡πå',
    pageIcon: 'üéÅ',
    pageTitle: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ä‡∏£‡πå',
    pageSubtitle: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
    username: username,
    activePage: 'activities'
}) %>

<!-- Stats -->
<div class="stats">
    <div class="stat-card">
        <div class="icon">üë•</div>
        <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="value"><%= totalUsers %></div>
    </div>

    <div class="stat-card">
        <div class="icon">‚è±Ô∏è</div>
        <h3>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ Cooldown</h3>
        <div class="value"><%= cooldownHours %> ‡∏ä‡∏°.</div>
    </div>

    <div class="stat-card">
        <div class="icon">üîë</div>
        <h3>‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h3>
        <div class="value"><%= keywords.split(',').length %></div>
    </div>

    <div class="stat-card">
        <div class="icon">‚úÖ</div>
        <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</h3>
        <div class="value"><%= usersCanSend %></div>
    </div>
</div>

<!-- Activity Message Section -->
<div class="section">
    <h2>
        üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        <button class="btn btn-primary" onclick="toggleEdit('activity')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>

    <div id="activityDisplay">
        <div class="display-box"><%= activityMessage %></div>
        <div class="info-box">
            üí° <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        </div>
    </div>

    <div id="activityEdit" class="hidden">
        <div class="form-group">
            <label for="activityMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
            <textarea id="activityMessage" style="min-height: 200px; font-family: inherit;"><%= activityMessage %></textarea>
            <small>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</small>
        </div>
        <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" onclick="toggleEdit('activity')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<!-- Cooldown Message Section -->
<div class="section">
    <h2>
        ‚è∞ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Cooldown
        <button class="btn btn-primary" onclick="toggleEdit('cooldownMsg')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>

    <div id="cooldownMsgDisplay">
        <div class="display-box"><%= cooldownMessage %></div>
        <div class="info-box">
            üí° <strong>‡πÉ‡∏ä‡πâ Placeholder:</strong> <code>{timeLeft}</code> ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏ä‡πà‡∏ô "2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á 30 ‡∏ô‡∏≤‡∏ó‡∏µ"
        </div>
    </div>

    <div id="cooldownMsgEdit" class="hidden">
        <div class="form-group">
            <label for="cooldownMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Cooldown</label>
            <textarea id="cooldownMessage" style="min-height: 120px; font-family: inherit;"><%= cooldownMessage %></textarea>
            <small>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Cooldown</small>
            <div class="info-box" style="margin-top: 10px;">
                üí° <strong>Placeholder ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:</strong> <code>{timeLeft}</code> = ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô "2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á 30 ‡∏ô‡∏≤‡∏ó‡∏µ")
            </div>
        </div>
        <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" onclick="toggleEdit('cooldownMsg')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<!-- Keywords Section -->
<div class="section">
    <h2>
        üîë ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
        <button class="btn btn-primary" onclick="toggleEdit('keywords')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>

    <div id="keywordsDisplay">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
            <% keywords.split(',').forEach(keyword => { %>
                <span style="background: #667eea; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em;">
                    <%= keyword.trim() %>
                </span>
            <% }); %>
        </div>
        <div class="info-box" style="margin-top: 15px;">
            üí° <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ
        </div>
    </div>

    <div id="keywordsEdit" class="hidden">
        <div class="form-group">
            <label for="keywords">‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</label>
            <input type="text" id="keywords" value="<%= keywords %>" placeholder="‡∏ü‡∏£‡∏µ, free, ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ">
            <small>‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,)</small>
        </div>
        <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" onclick="toggleEdit('keywords')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<!-- Cooldown Time Section -->
<div class="section">
    <h2>
        ‚è±Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ Cooldown
        <button class="btn btn-primary" onclick="toggleEdit('cooldown')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>

    <div id="cooldownDisplay">
        <div class="display-box"><%= cooldownHours %> ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
        <div class="info-box">
            üí° <strong>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        </div>
    </div>

    <div id="cooldownEdit" class="hidden">
        <div class="form-group">
            <label for="cooldownHours">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ Cooldown (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</label>
            <input type="number" id="cooldownHours" value="<%= cooldownHours %>" min="0.1" step="0.1" placeholder="2">
            <small>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 2 = 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á, 0.5 = 30 ‡∏ô‡∏≤‡∏ó‡∏µ)</small>
        </div>
        <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" onclick="toggleEdit('cooldown')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<!-- Users Table Section -->
<div class="section">
    <h2>üë§ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
    
    <% if (users.length === 0) { %>
        <div class="empty-state">
            <div class="icon">üì≠</div>
            <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <p>‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
    <% } else { %>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background: #667eea; color: white;">
                    <tr>
                        <th style="padding: 15px; text-align: left;">#</th>
                        <th style="padding: 15px; text-align: left;">User ID</th>
                        <th style="padding: 15px; text-align: left;">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                        <th style="padding: 15px; text-align: left;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th style="padding: 15px; text-align: left;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach((user, index) => { %>
                        <tr style="border-bottom: 1px solid #ddd; <% if (index % 2 === 0) { %>background: #f9f9f9;<% } %>">
                            <td style="padding: 15px;"><%= index + 1 %></td>
                            <td style="padding: 15px;"><%= user.userId.substring(0, 20) %>...</td>
                            <td style="padding: 15px;"><%= user.lastSent %></td>
                            <td style="padding: 15px;">
                                <span style="padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold; background: <%= user.canSend ? '#d4edda' : '#fff3cd' %>; color: <%= user.canSend ? '#155724' : '#856404' %>;">
                                    <%= user.canSend ? '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : '‚è≥ ‡∏£‡∏≠' %>
                                </span>
                            </td>
                            <td style="padding: 15px;"><%= user.remainingTime %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <button class="btn btn-primary" onclick="location.reload()" style="margin: 20px auto; display: block;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <% } %>
</div>

<script>
    let editingSection = null;

    function toggleEdit(section) {
        const display = document.getElementById(section + 'Display');
        const edit = document.getElementById(section + 'Edit');
        
        if (editingSection && editingSection !== section) {
            document.getElementById(editingSection + 'Display').classList.remove('hidden');
            document.getElementById(editingSection + 'Edit').classList.add('hidden');
        }
        
        display.classList.toggle('hidden');
        edit.classList.toggle('hidden');
        
        editingSection = edit.classList.contains('hidden') ? null : section;
    }

    async function saveSettings() {
        const activityMessage = document.getElementById('activityMessage').value;
        const cooldownMessage = document.getElementById('cooldownMessage').value;
        const keywords = document.getElementById('keywords').value;
        const cooldownHours = document.getElementById('cooldownHours').value;

        try {
            const response = await fetch('/activities/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    activityMessage,
                    cooldownMessage,
                    keywords,
                    cooldownHours
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', result.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    }

    // Auto refresh every 60 seconds
    setTimeout(() => {
        if (!editingSection) {
            location.reload();
        }
    }, 60000);
</script>

<%- include('partials/footer') %>