<%- include('partials/header', {
    title: 'Dashboard',
    pageIcon: 'üìä',
    pageTitle: 'Dashboard',
    pageSubtitle: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö LINE OA Bot',
    username: username,
    activePage: 'dashboard'
}) %>

<!-- Stats Section -->
<div class="stats">
    <div class="stat-card">
        <div class="icon">üë•</div>
        <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="value"><%= totalUsers %></div>
        <small style="color: #666;">‡∏à‡∏≤‡∏Å userMessageHistory</small>
    </div>

    <div class="stat-card">
        <div class="icon">üì±</div>
        <h3>LINE Channels</h3>
        <div class="value"><%= activeChannels %>/<%= totalChannels %></div>
        <small style="color: #666;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
    </div>

    <div class="stat-card">
        <div class="icon">üéÅ</div>
        <h3>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ä‡∏£‡πå</h3>
        <div class="value"><%= enabledActivities %>/<%= totalActivities %></div>
        <small style="color: #666;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
    </div>

    <div class="stat-card">
        <div class="icon">üì¶</div>
        <h3>Message Boxes</h3>
        <div class="value"><%= totalMessageBoxes || 0 %></div>
        <small style="color: #666;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
    </div>

    <div class="stat-card">
        <div class="icon">üì¢</div>
        <h3>Broadcast ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div class="value"><%= totalBroadcasts || 0 %></div>
        <small style="color: #666;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <%= successfulBroadcasts || 0 %> | ‡∏£‡∏≠‡∏™‡πà‡∏á: <%= scheduledBroadcasts || 0 %></small>
    </div>

    <div class="stat-card">
        <div class="icon">üë§</div>
        <h3>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Broadcast</h3>
        <div class="value"><%= totalBroadcastRecipients || 0 %></div>
        <small style="color: #666;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="section">
    <h2>üöÄ ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <a href="/broadcast" style="text-decoration: none;">
            <div style="background: linear-gradient(135deg, #06c755 0%, #00b900 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; transition: transform 0.3s; cursor: pointer;">
                <div style="font-size: 3em; margin-bottom: 10px;">üì¢</div>
                <h3 style="margin-bottom: 10px;">Broadcast Message</h3>
                <p style="opacity: 0.9; font-size: 0.9em;"><%= totalBroadcasts || 0 %> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            </div>
        </a>

        <a href="/activities" style="text-decoration: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; transition: transform 0.3s; cursor: pointer;">
                <div style="font-size: 3em; margin-bottom: 10px;">üéÅ</div>
                <h3 style="margin-bottom: 10px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ä‡∏£‡πå</h3>
                <p style="opacity: 0.9; font-size: 0.9em;"><%= totalActivities %> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
            </div>
        </a>

        <a href="/promotions" style="text-decoration: none;">
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; transition: transform 0.3s; cursor: pointer;">
                <div style="font-size: 3em; margin-bottom: 10px;">üé®</div>
                <h3 style="margin-bottom: 10px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h3>
                <p style="opacity: 0.9; font-size: 0.9em;"><%= totalPromotions %> Flex Messages</p>
            </div>
        </a>

        <a href="/settings" style="text-decoration: none;">
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; transition: transform 0.3s; cursor: pointer;">
                <div style="font-size: 3em; margin-bottom: 10px;">‚öôÔ∏è</div>
                <h3 style="margin-bottom: 10px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <p style="opacity: 0.9; font-size: 0.9em;"><%= totalChannels %> Channels</p>
            </div>
        </a>
    </div>
</div>

<!-- Active Activities Section -->
<% if (activities && activities.length > 0) { %>
<div class="section">
    <h2>üéÅ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
        <% activities.forEach(function(activity) { %>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea;">
                <h3 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">
                    <%= activity.name %>
                </h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em;">
                    <span style="color: #666;">üîë ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î:</span>
                    <strong><%= activity.keywords.length %> ‡∏Ñ‡∏≥</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em;">
                    <span style="color: #666;">üì¶ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</span>
                    <strong><%= activity.messageBoxes ? activity.messageBoxes.length : (activity.message ? 1 : 0) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em;">
                    <span style="color: #666;">‚è±Ô∏è Cooldown:</span>
                    <strong><%= activity.useCooldown !== false ? activity.cooldownHours + ' ‡∏ä‡∏°.' : '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' %></strong>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                    <span style="color: #666;">üì± Channels:</span>
                    <strong><%= activity.channels ? activity.channels.length : 0 %> ‡∏ä‡πà‡∏≠‡∏á</strong>
                </div>
            </div>
        <% }); %>
    </div>

    <% if (totalActivities > 5) { %>
        <div style="text-align: center; margin-top: 20px;">
            <a href="/activities" class="btn btn-primary">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= totalActivities %> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‚Üí</a>
        </div>
    <% } %>
</div>
<% } %>

<!-- System Info Section -->
<div class="section">
    <h2>‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
    
    <div class="info-box">
        <strong>ü§ñ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LINE Bot:</strong> 
        <%= lineConfigured ? '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + activeChannels + ' channel(s))' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö"' %>
    </div>

    <div class="info-box" style="margin-top: 10px;">
        <strong>üì° Webhook URL:</strong> 
        <code><%= webhookUrl %></code>
    </div>

    <div class="info-box" style="margin-top: 10px;">
        <strong>üîë ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> 
        <%= activityKeywordsList %>
    </div>

    <div class="info-box" style="margin-top: 10px;">
        <strong>üé® ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô:</strong> 
        <%= promotionKeywordsList %>
    </div>

    <div class="info-box" style="margin-top: 10px;">
        <strong>üì¶ Message Boxes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> 
        <%= totalMessageBoxes || 0 %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        <small style="display: block; color: #666; margin-top: 5px;">
            ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û, Flex Message)
        </small>
    </div>

    <div class="info-box" style="margin-top: 10px; background: #d4edda; border-left-color: #28a745; color: #155724;">
        <strong>üì¢ Broadcast Statistics:</strong><br>
        ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong><%= totalBroadcasts || 0 %></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | 
        ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong><%= successfulBroadcasts || 0 %></strong> | 
        ‡∏£‡∏≠‡∏™‡πà‡∏á: <strong><%= scheduledBroadcasts || 0 %></strong> | 
        ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°: <strong><%= totalBroadcastRecipients || 0 %></strong> ‡∏Ñ‡∏ô
    </div>
</div>

<!-- Recent Activity Section -->
<div class="section">
    <h2>üìã ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
    
    <% if (recentUsers.length === 0) { %>
        <div class="empty-state">
            <div class="icon">üì≠</div>
            <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <p>‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <small style="color: #999; margin-top: 10px; display: block;">
                üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å userMessageHistory: <%= totalUsers %> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            </small>
        </div>
    <% } else { %>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead style="background: #667eea; color: white;">
                <tr>
                    <th style="padding: 15px; text-align: left;">#</th>
                    <th style="padding: 15px; text-align: left;">User ID</th>
                    <th style="padding: 15px; text-align: left;">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                    <th style="padding: 15px; text-align: left;">‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th style="padding: 15px; text-align: left;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
            </thead>
            <tbody>
                <% recentUsers.forEach((user, index) => { %>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 15px;"><%= index + 1 %></td>
                        <td style="padding: 15px;"><%= user.userId.substring(0, 20) %>...</td>
                        <td style="padding: 15px;">
                            <span style="background: #e7f3ff; color: #1976D2; padding: 5px 10px; border-radius: 10px; font-size: 0.85em;">
                                <%= user.activityName %>
                            </span>
                        </td>
                        <td style="padding: 15px;"><%= user.lastSent %></td>
                        <td style="padding: 15px;">
                            <span style="padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold; background: <%= user.canSend ? '#d4edda' : '#fff3cd' %>; color: <%= user.canSend ? '#155724' : '#856404' %>;">
                                <%= user.canSend ? '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : '‚è≥ ‡∏£‡∏≠' %>
                            </span>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>

        <% if (totalUsers > 5) { %>
            <div style="text-align: center; margin-top: 20px;">
                <a href="/activities" class="btn btn-primary">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<%= totalUsers %> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ) ‚Üí</a>
            </div>
        <% } %>
    <% } %>
</div>

<!-- Debug Info (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Development) -->
<% if (process.env.NODE_ENV !== 'production') { %>
<div class="section" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 10px;">
    <h3 style="margin-top: 0; color: #856404;">üêõ Debug Info</h3>
    <div style="font-family: monospace; font-size: 0.9em; color: #666;">
        <strong>Total Users:</strong> <%= totalUsers %><br>
        <strong>UserMessageHistory Size:</strong> <%= totalUsers %><br>
        <strong>Activities:</strong> <%= totalActivities %> (Enabled: <%= enabledActivities %>)<br>
        <strong>Message Boxes:</strong> <%= totalMessageBoxes || 0 %><br>
        <strong>Total Broadcasts:</strong> <%= totalBroadcasts || 0 %><br>
        <strong>LINE Configured:</strong> <%= lineConfigured ? 'Yes' : 'No' %>
    </div>
</div>
<% } %>

<script>
    // Refresh every 60 seconds
    setTimeout(() => {
        location.reload();
    }, 60000);
</script>

<%- include('partials/footer') %>