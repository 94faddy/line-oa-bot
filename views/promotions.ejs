<%- include('partials/header', {
    title: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
    pageIcon: 'üé®',
    pageTitle: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
    pageSubtitle: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Flex Messages ‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
    username: username,
    activePage: 'promotions'
}) %>

<style>
    .promo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .promo-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s;
    }

    .promo-card:hover {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
    }

    .promo-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .promo-card-body {
        padding: 20px;
    }

    .promo-card-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }

    .promo-card-url {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 15px;
        word-break: break-all;
    }

    .promo-card-actions {
        display: flex;
        gap: 10px;
    }

    .promo-card-actions button {
        flex: 1;
        padding: 8px;
        font-size: 0.9em;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #28a745;
    }

    input:checked + .slider:before {
        transform: translateX(30px);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        animation: slideDown 0.3s;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        border: none;
        padding: 0;
    }

    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
    }

    .close:hover {
        opacity: 0.8;
    }

    .modal-body {
        padding: 30px;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        font-weight: bold;
        display: inline-block;
        margin-left: 10px;
    }

    .status-enabled {
        background: #d4edda;
        color: #155724;
    }

    .status-disabled {
        background: #f8d7da;
        color: #721c24;
    }

    @media (max-width: 768px) {
        .promo-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Promotion Settings Section -->
<div class="section">
    <h2>
        ‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        <button class="btn btn-primary" onclick="openSettingsModal()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>
    
    <div class="info-box">
        üí° <strong>‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <%= keywords %>
        <span class="status-badge <%= enabled ? 'status-enabled' : 'status-disabled' %>">
            <%= enabled ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' %>
        </span>
    </div>
</div>

<!-- Promotions List Section -->
<div class="section">
    <h2>
        üé® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        <button class="btn btn-success" onclick="openAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>
    </h2>

    <% if (promotions.length === 0) { %>
        <div class="empty-state">
            <div class="icon">üì≠</div>
            <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h3>
            <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
    <% } else { %>
        <div class="promo-grid">
            <% promotions.forEach(function(promo) { %>
                <div class="promo-card">
                    <img src="<%= promo.imageUrl %>" alt="<%= promo.title %>" onerror="this.src='https://via.placeholder.com/300x200/667eea/ffffff?text=No+Image'">
                    <div class="promo-card-body">
                        <div class="promo-card-title"><%= promo.title %></div>
                        <div class="promo-card-url">üîó <%= promo.linkUrl %></div>
                        <div class="promo-card-actions">
                            <button class="btn btn-primary" onclick="editPromotion('<%= promo.id %>', '<%= promo.title.replace(/'/g, "\\'") %>', '<%= promo.imageUrl %>', '<%= promo.linkUrl %>', <%= promo.enabled %>)">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-danger" onclick="deletePromotion('<%= promo.id %>')">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.9em; color: #666;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                            <label class="toggle-switch">
                                <input type="checkbox" <%= promo.enabled ? 'checked' : '' %> onchange="togglePromotion('<%= promo.id %>', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } %>
</div>

<!-- Add/Edit Promotion Modal -->
<div id="promoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <button class="close" onclick="closePromoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promoForm">
                <input type="hidden" id="promoId" name="id">
                
                <div class="form-group">
                    <label for="promoTitle">üìù ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</label>
                    <input type="text" id="promoTitle" name="title" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©" required>
                </div>

                <div class="form-group">
                    <label for="promoImageUrl">üñºÔ∏è URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <input type="url" id="promoImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg" required>
                    <small>‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: 1040x1040 ‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• (1:1)</small>
                </div>

                <div class="form-group">
                    <label for="promoLinkUrl">üîó URL ‡∏•‡∏¥‡∏á‡∏Å‡πå</label>
                    <input type="url" id="promoLinkUrl" name="linkUrl" placeholder="https://example.com/promotion" required>
                    <small>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</small>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn btn-secondary" onclick="closePromoModal()" style="flex: 1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h2>
            <button class="close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="settingsForm">
                <div class="form-group">
                    <label for="promoKeywords">üîë ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</label>
                    <input type="text" id="promoKeywords" name="keywords" value="<%= keywords %>" placeholder="‡πÇ‡∏õ‡∏£, ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô, promo" required>
                    <small>‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,)</small>
                </div>

                <div class="form-group">
                    <label for="promoEnabled">
                        <input type="checkbox" id="promoEnabled" name="enabled" <%= enabled ? 'checked' : '' %>>
                        ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
                    </label>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()" style="flex: 1;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Store promotions data for JavaScript
    var promotionsData = <%- JSON.stringify(promotions) %>;
    var isEditMode = false;

    document.getElementById('promoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var formData = {
            id: document.getElementById('promoId').value,
            title: document.getElementById('promoTitle').value,
            imageUrl: document.getElementById('promoImageUrl').value,
            linkUrl: document.getElementById('promoLinkUrl').value,
            enabled: true
        };
        var url = isEditMode ? '/promotions/update' : '/promotions/add';
        try {
            var response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            var result = await response.json();
            if (result.success) {
                showAlert('success', result.message);
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    });

    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var formData = {
            keywords: document.getElementById('promoKeywords').value,
            enabled: document.getElementById('promoEnabled').checked
        };
        try {
            var response = await fetch('/promotions/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            var result = await response.json();
            if (result.success) {
                showAlert('success', result.message);
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    });

    function openAddModal() {
        isEditMode = false;
        document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('promoForm').reset();
        document.getElementById('promoId').value = '';
        document.getElementById('promoModal').style.display = 'block';
    }

    function editPromotion(id, title, imageUrl, linkUrl, enabled) {
        isEditMode = true;
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô';
        document.getElementById('promoId').value = id;
        document.getElementById('promoTitle').value = title;
        document.getElementById('promoImageUrl').value = imageUrl;
        document.getElementById('promoLinkUrl').value = linkUrl;
        document.getElementById('promoModal').style.display = 'block';
    }

    function closePromoModal() {
        document.getElementById('promoModal').style.display = 'none';
    }

    function openSettingsModal() {
        document.getElementById('settingsModal').style.display = 'block';
    }

    function closeSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    window.onclick = function(event) {
        var promoModal = document.getElementById('promoModal');
        var settingsModal = document.getElementById('settingsModal');
        if (event.target == promoModal) {
            closePromoModal();
        }
        if (event.target == settingsModal) {
            closeSettingsModal();
        }
    }

    async function togglePromotion(id, enabled) {
        try {
            var promo = promotionsData.find(function(p) { return p.id === id; });
            if (!promo) {
                showAlert('error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô');
                return;
            }
            var response = await fetch('/promotions/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    title: promo.title,
                    imageUrl: promo.imageUrl,
                    linkUrl: promo.linkUrl,
                    enabled: enabled
                })
            });
            var result = await response.json();
            if (result.success) {
                showAlert('success', enabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            } else {
                showAlert('error', result.message);
                setTimeout(function() { location.reload(); }, 1000);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            setTimeout(function() { location.reload(); }, 1000);
        }
    }

    async function deletePromotion(id) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ?')) {
            return;
        }
        try {
            var response = await fetch('/promotions/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            var result = await response.json();
            if (result.success) {
                showAlert('success', result.message);
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    }
</script>

<%- include('partials/footer') %>