<%- include('partials/header', {
    title: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
    pageIcon: '‚öôÔ∏è',
    pageTitle: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
    pageSubtitle: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE API ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
    username: username,
    activePage: 'settings'
}) %>

<!-- LINE Configuration Section -->
<div class="section">
    <h2>
        üîó ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE OA
        <button class="btn btn-primary" onclick="toggleEdit('lineConfig')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </h2>

    <div id="lineConfigDisplay">
        <div style="background: <%= lineAccessToken ? '#d4edda' : '#fff3cd' %>; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid <%= lineAccessToken ? '#28a745' : '#ffc107' %>;">
            <h3 style="color: <%= lineAccessToken ? '#155724' : '#856404' %>; margin-bottom: 15px;">
                <%= lineAccessToken ? '‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' %>
            </h3>
            <p><strong>Channel Access Token:</strong> <%= lineAccessToken ? '‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß (' + lineAccessToken.substring(0, 20) + '...)' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' %></p>
            <p style="margin-top: 10px;"><strong>Channel Secret:</strong> <%= lineChannelSecret ? '‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß (' + lineChannelSecret.substring(0, 10) + '...)' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' %></p>
        </div>

        <div class="info-box">
            üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤ Channel Access Token ‡πÅ‡∏•‡∏∞ Channel Secret:</strong><br>
            1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://developers.line.biz/console/" target="_blank" style="color: #667eea;">LINE Developers Console</a><br>
            2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Provider ‡πÅ‡∏•‡∏∞ Channel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
            3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "Messaging API"<br>
            4. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "Channel access token" ‡πÅ‡∏•‡∏∞ "Channel secret"
        </div>
    </div>

    <div id="lineConfigEdit" class="hidden">
        <div class="form-group">
            <label for="lineAccessToken">üîë LINE Channel Access Token</label>
            <input type="text" id="lineAccessToken" value="<%= lineAccessToken %>" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Channel Access Token">
            <small>‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà LINE Developers Console ‚Üí Messaging API</small>
        </div>

        <div class="form-group">
            <label for="lineChannelSecret">üîê LINE Channel Secret</label>
            <input type="text" id="lineChannelSecret" value="<%= lineChannelSecret %>" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Channel Secret">
            <small>‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà LINE Developers Console ‚Üí Basic settings</small>
        </div>

        <button class="btn btn-success" onclick="saveLineSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" onclick="toggleEdit('lineConfig')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<!-- Webhook Configuration Section -->
<div class="section">
    <h2>üîî Webhook URL</h2>
    
    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border-left: 5px solid #2196F3;">
        <h3 style="color: #1976D2; margin-bottom: 15px;">üìç Webhook URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div style="background: white; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; word-break: break-all; margin-bottom: 15px;">
            <%= webhookUrl %>
        </div>
        <button class="btn btn-primary" onclick="copyWebhookUrl()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL</button>
    </div>

    <div class="info-box" style="margin-top: 20px;">
        üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Webhook URL ‡πÉ‡∏ô LINE:</strong><br>
        1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://developers.line.biz/console/" target="_blank" style="color: #667eea;">LINE Developers Console</a><br>
        2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Provider ‡πÅ‡∏•‡∏∞ Channel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
        3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "Messaging API"<br>
        4. ‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô "Webhook settings"<br>
        5. ‡∏Å‡∏î "Edit" ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á Webhook URL<br>
        6. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô "Use webhook" ‡πÅ‡∏•‡∏∞ "Verify webhook"
    </div>
</div>

<!-- Server Configuration Section -->
<div class="section">
    <h2>üñ•Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea;">
            <h4 style="color: #667eea; margin-bottom: 10px;">üîå Server Port</h4>
            <p style="font-size: 1.5em; font-weight: bold; color: #333;"><%= serverPort %></p>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #28a745;">
            <h4 style="color: #28a745; margin-bottom: 10px;">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h4>
            <p style="font-size: 1.5em; font-weight: bold; color: #333;">‚úÖ Online</p>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #17a2b8;">
            <h4 style="color: #17a2b8; margin-bottom: 10px;">üïê Uptime</h4>
            <p style="font-size: 1.5em; font-weight: bold; color: #333;"><%= uptime %></p>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #ffc107;">
            <h4 style="color: #e0a800; margin-bottom: 10px;">üì¶ Version</h4>
            <p style="font-size: 1.5em; font-weight: bold; color: #333;">2.0</p>
        </div>
    </div>
</div>

<!-- API Test Section -->
<div class="section">
    <h2>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
    
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
        <h4 style="margin-bottom: 15px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Webhook</h4>
        <p style="margin-bottom: 15px; color: #666;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Bot</p>
        <button class="btn btn-warning" onclick="testWebhook()" id="testBtn">üî¨ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <div id="testResult" style="margin-top: 15px;"></div>
    </div>

    <div class="info-box" style="margin-top: 20px;">
        üí° <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Webhook URL ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    </div>
</div>

<!-- Danger Zone Section -->
<div class="section">
    <h2 style="color: #dc3545;">‚ö†Ô∏è Danger Zone</h2>
    
    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; border-left: 5px solid #dc3545;">
        <h4 style="color: #721c24; margin-bottom: 15px;">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h4>
        <p style="color: #721c24; margin-bottom: 15px;">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ)</p>
        <button class="btn btn-danger" onclick="clearUserData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </div>
</div>

<script>
    let editingSection = null;

    function toggleEdit(section) {
        const display = document.getElementById(section + 'Display');
        const edit = document.getElementById(section + 'Edit');
        
        if (editingSection && editingSection !== section) {
            document.getElementById(editingSection + 'Display').classList.remove('hidden');
            document.getElementById(editingSection + 'Edit').classList.add('hidden');
        }
        
        display.classList.toggle('hidden');
        edit.classList.toggle('hidden');
        
        editingSection = edit.classList.contains('hidden') ? null : section;
    }

    async function saveLineSettings() {
        const lineAccessToken = document.getElementById('lineAccessToken').value;
        const lineChannelSecret = document.getElementById('lineChannelSecret').value;

        if (!lineAccessToken || !lineChannelSecret) {
            showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            return;
        }

        try {
            const response = await fetch('/settings/line', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lineAccessToken, lineChannelSecret })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', result.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    }

    function copyWebhookUrl() {
        const url = '<%= webhookUrl %>';
        navigator.clipboard.writeText(url).then(() => {
            showAlert('success', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Webhook URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }).catch(() => {
            showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ');
        });
    }

    async function testWebhook() {
        const btn = document.getElementById('testBtn');
        const result = document.getElementById('testResult');
        
        btn.disabled = true;
        btn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
        result.innerHTML = '';

        try {
            const response = await fetch('/settings/test-webhook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                result.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 10px;">‚úÖ ${data.message}</div>`;
            } else {
                result.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 10px;">‚ùå ${data.message}</div>`;
            }
        } catch (error) {
            result.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 10px;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üî¨ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        }
    }

    async function clearUserData() {
        if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
            return;
        }

        if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }

        try {
            const response = await fetch('/settings/clear-users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', result.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('error', result.message);
            }
        } catch (error) {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
    }
</script>

<%- include('partials/footer') %>